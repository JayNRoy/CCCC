{% extends "layout.html" %}

{% block title %}
    Chatting
{% endblock %}

{% block main %}
    <div class="chatbox">
        <br>
        Your conversation with {{ recipient }}:
        <br>
        <textarea id="currentConvo" name="currentConvo" cols="100" rows="25" readonly></textarea>
        </textarea>
    </div>
    <br>
    <label for="newMessage">Input your message:</label>
    <!-- <form action="/sendMessage" method="post">
        <div>
            <textarea style="resize:none" id="newMessage" name="newMessage" rows="4" cols="50" autofocus placeholder="Enter your message here...">
            </textarea>
        </div>
        <button class="btn btn-success" type="submit" id="btn-msg">Send</button>
    </form> -->
    <div action="/sendMessage" method="post">
        <div>
            <textarea style="resize:none" id="newMessage" name="newMessage" rows="4" cols="50" autofocus placeholder="Enter your message here..."></textarea>
        </div>
        <button class="btn btn-success" type="submit" id="btn-msg">Send</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script>
    server_url = "http://127.0.0.1:5000/"
    
    const socket = io.connect(server_url);

    socket.on("connect", function () {
        console.log("it has started the connection sequence")
        let chatRecipient = "{{ recipient }}";
        let currentUsername = "{{ username }}";

        let roomArray = [chatRecipient, currentUsername].sort();

        let room = `${roomArray[0]}&&${roomArray[1]}`;
        room = "1"
        console.log(`the room name is ${room}`);
        socket.emit('join_chat', {"roomName" : room, "username" : currentUsername});
    });

    socket.on("online_announcement", function(data) {
        if (data["username"] != "{{ username }}"){
            alert(`The user ${data["username"]} is ONLINE`);
        }
    })

    socket.on('msg_from_serv', function (data) {
        var chatbox = document.getElementById("currentConvo");
        chatbox.value += `${data["username"]}: ${data["msg_txt"]}\n`
    })

    var btn = document.getElementById("btn-msg");
    btn.addEventListener("click", function() {
        console.log("button clicked")
        var msg_txt = document.getElementById("newMessage").value
        document.getElementById("newMessage").value = ""
        socket.emit('msg_sent', {"msg_txt" : msg_txt, "username" : "{{ username }}"})
    })

    window.onbeforeunload = function () {
        socket.emit("leave_room", {})
    };

    socket.on("left_room", function (data) {
        alert(`${data["username"]} has left the room and is now OFFLINE`)
    })

    </script>
{% endblock %}